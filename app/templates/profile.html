{% extends "base.html" %}
{% block title %}Profile - Calcetto{% endblock %}
{% block content %}
<div class="flex items-center justify-between mb-3">
  <h1 class="text-xl font-bold">My Profile</h1>
  <a href="/players/{{ player.id }}" class="text-sm underline">Open full player page</a>
</div>

<div class="mb-3 text-sm text-slate-600">Logged as <strong>{{ player.name }}</strong></div>

<div class="grid grid-cols-2 gap-2 mb-4 text-sm">
  <button type="button" data-target="player-matches" class="stat-open-matches bg-white rounded p-3 shadow text-left hover:bg-slate-50">
    Matches: <strong>{{ stats.matches }}</strong>
  </button>
  <button type="button" data-metric="wins" class="metric-card bg-white rounded p-3 shadow text-left hover:bg-slate-50">Wins: <strong>{{ stats.wins }}</strong></button>
  <button type="button" data-metric="draws" class="metric-card bg-white rounded p-3 shadow text-left hover:bg-slate-50">Draws: <strong>{{ stats.draws }}</strong></button>
  <button type="button" data-metric="losses" class="metric-card bg-white rounded p-3 shadow text-left hover:bg-slate-50">Losses: <strong>{{ stats.losses }}</strong></button>
  <button type="button" data-metric="goals_scored" class="metric-card bg-white rounded p-3 shadow text-left hover:bg-slate-50">Goals Scored: <strong>{{ stats.goals_scored }}</strong></button>
  <button type="button" data-metric="goals_per_match" class="metric-card bg-white rounded p-3 shadow text-left hover:bg-slate-50">Goals/Match: <strong>{{ "%.2f"|format(stats.goals_per_match) }}</strong></button>
  <button type="button" data-metric="assists" class="metric-card bg-white rounded p-3 shadow text-left hover:bg-slate-50">Assists: <strong>{{ stats.assists }}</strong></button>
  <button type="button" data-metric="goals_conceded" class="metric-card bg-white rounded p-3 shadow text-left hover:bg-slate-50">Goals Conceded: <strong>{{ stats.goals_conceded }}</strong></button>
  <button type="button" data-metric="win_rate" class="metric-card bg-white rounded p-3 shadow text-left hover:bg-slate-50">Win Rate: <strong>{{ "%.1f"|format(stats.win_rate * 100) }}%</strong></button>
  <button type="button" data-metric="elo" class="metric-card bg-white rounded p-3 shadow text-left hover:bg-slate-50">ELO: <strong>{{ "%.1f"|format(stats.elo_placeholder) }}</strong></button>
</div>

<div class="bg-white rounded-xl p-4 shadow">
  <h2 id="metricTitle" class="font-semibold mb-2">ELO Over Time</h2>
  <canvas id="profileEloChart"></canvas>
</div>

<section id="player-matches" class="bg-white rounded-xl p-4 shadow mt-4 hidden">
  <h2 class="font-semibold mb-3">Matches Played</h2>
  <ul class="space-y-3">
    {% for m in player_matches %}
    <li class="border rounded p-3">
      <a href="/matches/{{ m.match_id }}" class="font-semibold underline">{{ m.date }}</a>
      <div class="text-sm mt-1">Score: {{ m.goals_a }} - {{ m.goals_b }} ({{ m.winner }})</div>
      <div class="text-xs text-slate-600 mt-1">A: {{ m.team_a_players|join(', ') }}</div>
      <div class="text-xs text-slate-600">B: {{ m.team_b_players|join(', ') }}</div>
    </li>
    {% else %}
    <li class="border rounded p-3 text-sm">No matches for this player.</li>
    {% endfor %}
  </ul>
</section>
<script>
const labels = {{ timeline_labels | safe }};
const series = {{ timeline_series | safe }};
const ctx = document.getElementById('profileEloChart');
const title = document.getElementById('metricTitle');
const metricCards = Array.from(document.querySelectorAll('.metric-card'));
const matchesBtn = document.querySelector('.stat-open-matches');
const matchesSection = document.getElementById('player-matches');

const chart = new Chart(ctx, {
  type: 'line',
  data: {
    labels,
    datasets: [{
      label: 'ELO',
      data: series.elo.values,
      borderColor: '#2563eb',
      backgroundColor: 'rgba(37, 99, 235, 0.15)',
      tension: 0.25,
      fill: true,
    }]
  },
  options: {
    scales: { y: { beginAtZero: true } },
    plugins: { legend: { display: true } }
  }
});

function setActiveMetric(metric) {
  metricCards.forEach((card) => {
    const isActive = card.dataset.metric === metric;
    card.classList.toggle('bg-blue-600', isActive);
    card.classList.toggle('text-white', isActive);
    card.classList.toggle('hover:bg-blue-500', isActive);
    card.classList.toggle('bg-white', !isActive);
  });
}

function setMetric(metric) {
  const metricData = series[metric];
  if (!metricData) return;
  chart.data.datasets[0].label = metricData.label;
  chart.data.datasets[0].data = metricData.values;
  chart.update();
  title.textContent = `${metricData.label} Over Time`;
  setActiveMetric(metric);
}

metricCards.forEach((card) => {
  card.addEventListener('click', () => setMetric(card.dataset.metric));
});

matchesBtn.addEventListener('click', () => {
  matchesSection.classList.toggle('hidden');
  if (!matchesSection.classList.contains('hidden')) {
    matchesSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
  }
});

setMetric('elo');
</script>
{% endblock %}
